---
title: "Births Analysis 2012 Markdown for 799C 2018"
author: "Mike Dolan Fliss, Nick Brazeau, & Sara Levintow"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    highlight: tango
    theme: lumen
    toc: yes
    toc_float: yes
    result_folding: hide
editor_options: 
  chunk_output_type: console
---

<!-- java script and functionality from: https://stackoverflow.com/questions/37755037/how-to-add-code-folding-to-output-chunks-in-rmarkdown-html-documents -->

<script src="js/hideOutput.js"></script>

<!-- Styling out the output buttom here on the fly with CSS -->
<style>
    .showopt {
      background-color: #004c93;
      color: #FFFFFF; 
      width: 100px;
      height: 20px;
      text-align: center;
      vertical-align: middle !important;
      float: right;
      font-family: sans-serif;
      border-radius: 8px;
    }
    
    .showopt:hover {
        background-color: #dfe4f2;
        color: #004c93;
    }
    
    pre.plot {
      background-color: white !important;
    }

</style>

<!-- Styling ordered lists for Rmarkdown -->
<!-- https://stackoverflow.com/questions/13366820/how-do-you-make-lettered-lists-using-markdown -->
<style>
    ol { list-style-type: numeric; }
</style>
<style>
    ol ol { list-style-type: upper-alpha; }
</style>
<style>
    ol ol ol { list-style-type: lower-roman; }
</style>


<!-- TODO --  this CSS script isn't getting picked up... it is in my markdown IDE -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Acknowledgements
Several instructors have come before us and have made this work possible, those instructors include: **Nat MacNell**, **Anne**, among others.   

_All thanks to those above, but all errors are our own._

# Overview of Homeworks 1-4
In this series of homeworks, we will analyze the effect of **prenatal care** (exposure) on **preterm birth** (outcome). To estimate this effect we will need to do the basics of any epidemiology project:  

1. Clean the data (i.e. "Datawrangling"" and making the data [tidy](https://vita.had.co.nz/papers/tidy-data.pdf))   
2. Descriptive Statistics 
	1. Univariate Analyses
	2. Bivariate Analyses
	3. Data Visualization
	4. More data visualization
3. Modeling
  
_As an added bonus, these homeworks will also cover some basic spatial analyses and other "advanced techniques"._ 


# Homework 1
## Overview of Homework 1
The purpose of this homework is to introduce you to the under-the-hood machinery of R and provide some context/practice with data wrangling.

### Question 1, Comments and code structure 
1. Now that you’ve got the code loaded, let’s think ahead and plan to write well-structured code. Show you can use these organization and commenting techniques throughout the following questions:    
	1. Include a descriptive header and your research question for the overall analysis (put this as a #comment in your code header). 
	2. Include “comment bars” for visual breaks. 
	3. Include descriptive comments, both at the start of a line and after a line of runnable code.  
	4. Include at least one comment with a relevant, clickable web reference
	5.  Organize your code into collapsible code blocks 
	6. Make your first code block loading basic libraries and setting your working directory with `setwd()`. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}

# Please note this is an example of code chunks you may have at the top of a .R but would differ for a Rmarkdown file (which wraps the markdown language)

#............................
# Births 2012 Analysis for EPID 799C: PNC decrease PT birth? ####
# Mike Dolan Fliss, August 2017
# Aim: Does early prenatal care (<month 5) decrease the risk of preterm (<week 37) birth?
# (This Descriptive header is HW1.Q1a)
#............................ (<- example of HW1.Q1b, comment bar)
# Project Notes:
# Birth Certificate Revisions: https://www.cdc.gov/nchs/nvss/vital_certificate_revisions.htm (HW1.Q1d, clickable link)
#............................

#............................
# Libraries, directories, load data (HW1.Q1f) ####
#............................
# NOTE: May need to install these packages in advance on your local machine.
# install.packages("tableone")
library(tidyverse) # for ggplot, dplyr in HW1-4 (<- example of a post-line code comment, HW1.Q1c)
library(lubridate) # for dates in HW2
devtools::install_github("kaz-yos/tableone") # used in HW2, need for github for kableone functipn from PR #32 (https://github.com/kaz-yos/tableone/pull/32)
library(tableone)
# Set directories. 
data_dir = paste0(getwd(), "/data")
output_dir = paste0(getwd(), "/data")
# map_dir = paste0(data_dir, "/GIS") # used later
# Note you'll need to set different ones with setwd()! Since we're building this as a github repo the wd defaults to script dir.
# More on git here: http://r-bio.github.io/intro-git-rstudio/ . There's also a datacamp on it.
#............................

```
</div>

### Question 2, Read the file
1. This assignment will use the dataset births.csv from Sakai.     
	1. Read in the “full” births2012.csv file into a data.frame called “births,” as we have done in class. This time, use the “stringsAsFactors” parameter set to F or FALSE to avoid R automatically coding character strings as factors. (_In practice you will likely use_ `tidyverse::read_csv` but in this case use `base::read.csv`) 
	2. Print out the first few rows. What function did you use? (5 points) 
	3. Optional Challenge: [Read Strings as Factors: An Authorized Biography and StringsAsFactors = sigh](https://simplystatistics.org/2015/07/24/stringsasfactors-an-unauthorized-biography/).  

<div class="fold o"> 
```{r, echo=T, warning=F, message=F}
#............................
# Read data (HW1.Q2) ####
#............................
births = read.csv("data/births2012.csv", stringsAsFactors = F) # (HW1.Q2a)
names(births) = tolower(names(births)) #drop names to lowercase
head(births) # (HW1.Q2b)

```
</div>


### Question 3, Basic Operations
1. Basic operations on datasets 
	1. Using all of these functions in in code: summary, head, tail, str, names, dim. 
	2. Create a code chunk called “Exploring Data” 
	3. Report the number of records and fields in the dataset.  
	4. Report the five-number summary for the WKSGEST and MDIF variables. 
	5. Pick three variables we will use for our analysis and report their type (numeric, character, etc.).  
	
<div class="fold o"> 
```{r, echo=T, warning=F, message=F}
# ......................................
# Exploring Data - (HW1Q3) ####
# ......................................
dim(births) # (HW1.Q3b) 
summary(births[,c("wksgest", "mdif")]) # (HW1.Q3c) 
str(births[,c("mage", "wksgest", "mdif")]) # (HW1.Q3d) 
class(births$mage)
class(births$wksgest)
class(births$mdif) 
str(births$mage)
str(births$wksgest)
str(births$mdif)

```
</div>


### Question 4, Subsetting & EDA
1. Subsetting, loading packages & making graphics 
	1. In the same “Exploring” code chunk, using the selection operators [], create a smaller version of the births file called births_sample with only the first 1000 rows and with only these variables:"MAGE", "MDIF", "VISITS", "WKSGEST", "MRACE". 
	2. Plot this smaller dataset all at once using the base plot(births_sample) function. Paste the plot in here. What does this plot show? 
	3. Optional Challenges: Install and load the package “car”, and plot the smaller dataset using scatterplotMatrix(). If you are familiar with ggplot2, you might try the ggpairs() function in the GGally package. If you’re comfortable with functions, consider using the sample() function to get a random sample for births_sample, instead of the first 1000 rows. 



<div class="fold o"> 
```{r, echo=T, warning=F, message=F}
# ......................................
# Exploring Data - (HW1Q4) ####
# ......................................
## (HW1.Q4) 
births_sample = births[1:1000, c("mage", "mdif", "visits", "wksgest", "mrace")] #A

plot(births_sample) #B

births_sample = births[sample(nrow(births), 1000), c("mage", "mdif", "visits", "wksgest", "mrace")] #C
# install.packages(c("car", "GGally"))
car::scatterplotMatrix(births_sample)
GGally::ggpairs(births_sample)

```
</div>


### Question 5, Recoding
1. Recode the following variables we plan to use in our main analysis. _Note that we will learn faster ways to do many of these steps, but for now, use what you know._   
We’ll be coding integers, factors, and dates.   
**Suggestion: start a new section called “Recoding.”**.  
	1. Prenatal Care 
		1. Create a table of mdif and paste it here 
		2. What do mdif 88 and mdif 99 mean?  
		3. Assign 99 to R’s missing value (and 88, eventually, to no early PNC). 
		4. Create a relevant univariate plot for mdif and paste it in. 
		5. Create a numeric variable pnc5 that is a 1 if month prenatal care began is less than or equal to 5, 0 if later, and NA if missing. 
		6. Create a factor variable pnc5_f based on pnc5 with labels "No Early PNC" and "Early PNC" 
		7. Check your result with a bivariate table of pnc5_f and mdif (useNA=”always” will be relevant here). Paste it in here. 
	2. Preterm Birth 
		1. Create a histogram of wksgest and paste it here. 
		2. Create an integer variable called preterm that is a 1 if wksgest is at least 20 weeks but less than 37 weeks, 0 if at least 37 weeks, and missing if missing. 
		3. Create a factor variable preterm_f based on the preterm integer variable following the same coding as preterm, labeling the right levels as “term” and “preterm.” 
		4. **Optional Challenge**: Create a factor variable preterm_f in one step, based on the original wksgest integer variable following the same coding as preterm using the cut() function, labeling the right levels as “term” and “preterm.” 
	3. Plurality 
		1.	We’ll be using plurality as a selection critieria. Create a table of plur to confirm it is coded properly.
	4. Maternal Age 
		1. 	Create a table of mage, and paste it here. 
		2. What does mage =99 mean, specifically? See the code book. 
		3. Assign mage =99 to R’s “missing” value. 
		4. Create and paste in a univariate graph of mage. Consider using boxplot, density plot [hint: `plot(density(x))`] or histogram. 
		5. Create a centered mage_centered variable in the dataset, equal to the mage minus the mean of mage. Report its fivenumber summary. 
	5. Cigarette Use 
		1. Recode the existing cigdur character variable to a new integer variable smoke so that it is coded as 1 for “Y”, 0 for “N”, and missing otherwise.  
		2. Convert that integer variable smoke to a factor variable smoker_f with levels “Smoker” and “Non-smoker” 
		3. Make sure your recoding is right by creating a two-way frequency table between the new variable smoke_f (row variable) and the old variable cigdur (column variable). Paste the output here. 
	6. Date of Birth 
		1. Find the `lubridate` package’s [github page](https://github.com/tidyverse/lubridate) and skim it 
		2. Run `?lubridate` and `vignette(“lubridate”)` to explore the package 
		3. Load the lubridate (or tidyverse!) package at the top of your script (suggestion: a chunk called “packages & data”) 
		4. Use helpful functions like `lubridate::ymd()` to convert the dob string variable into a date-typed version called dob_d 
	7. Sex 
		1. Using skills from the previous questions, code the factor variable sex_f as “M”, “F”, or missing. Use a table to confirm your recoding. 
	8. Maternal Race / Ethnicity (_please see the homework for an important note/discussion on race-ethnicity!_)  
		1. Use a bivariate table() to investigate the covariate relationships of maternal race and ethnicity. 
		2. Create a raceeth_f factor variable from mrace and methnic for these (limited!) categories: White non-Hispanic, White Hispanic, African American (any methnic value), American Indian or Alaska Native (any methnic value) and Other (including unknown or any missing values).  
		3. Create one or more tables (note table(a,b,c) is valid syntax) to confirm coding of the race-ethnicity variable

<div class="fold o"> 
```{r, echo=T, warning=F, message=F}
## (HW1.Q5) 
### A. Prenatal Care (Exposure) 
#### i
table(births$mdif, useNA = "always") 

#### ii
# See data dictionary, but 88 means no early prenatal care and 99 means missing

#### iii
births$mdif[births$mdif==99] <- NA 

#### iv
boxplot(births$mdif[births$mdif != 88], main="Month Prenatal Care Began, \n Excluding Unkowns and No Prenatal Care")

#### v
births$pnc5 <- ifelse(births$mdif <= 5, 1, 0) 

#### vi
births$pnc5_f <- factor(births$pnc5, levels=c(0,1), labels=c("No Early PNC", "Early PNC"))

#### vii
table(births$mdif, births$pnc5_f, useNA = "always")


# (HW1.Q5 continued) 
### B. Preterm Birth (Outcome) 
#### i
hist(births$wksgest) #quick look
#### ii
births$preterm <- ifelse(births$wksgest >= 20 &births$wksgest < 37, 1,
                                     ifelse(births$wksgest >= 37 & births$wksgest < 99, 0, NA)
                        )

#### iii
births$preterm_f <- factor(births$preterm, levels=c(0,1), labels=c("term", "preterm"))

#### iv
births$preterm_f <- cut(births$wksgest, breaks = c(036,99), labels =  c("preterm", "term")) #should be no births too young at this point

# (HW1.Q5 continued) 
### C. Plurality (covariate) 
#### i
table(births$plur, useNA = "always") # looks fine, no 9 values for unknown

# (HW1.Q5 continued) 
### D. Maternal Age (covariate) 
#### i
table(births$mage, useNA = "always") 

#### ii
# See data dictionary, but 99 means misssing

#### iii
births$mage[births$mage==99] <- NA 

#### iv
par(mfrow=c(1,2))
boxplot(births$mage, main="Boxplot of Maternal Age Distribution")
plot(density(births$mage[!is.na(births$mage)]), main="Density Plot of Maternal Age Distribution")
dev.off() # turning back to default

#### v
births$mage_centered <- births$mage - mean(births$mage, na.rm = T)
hist(births$mage) # looks to be expected
summary(births$mage)

# (HW1.Q5 continued) 
### E. Cigarette Use (covariate) 
#### i
table(births$cigdur, useNA = "always") # check to see what values are in cigdur
births$cigdur <- ifelse(births$cigdur == "Y", 1, 
                     ifelse(births$cigdur == "N", 0, NA)) # NA for when case is U - i.e. unknown

#### ii
births$smoker_f <- factor(births$cigdur, levels=c(0,1), labels=c("Non-smoker", "Smoker"))

#### ii
table(births$cigdur, births$smoker_f, useNA = "always")


# (HW1.Q5 continued) 
### F. Date of Birth (covariate) 
#### i
# https://github.com/tidyverse/lubridate
#### ii
?lubridate
# vignette("lubridate") 

#### iii
library(lubridate) # normally this would go at the top of the script under a packages chunk 

#### iv
births$dob_d <- lubridate::ymd(births$dob)

# (HW1.Q5 continued) 
### G. Sex (covariate) 
#### i
table(births$sex, useNA = "always") # check what initial values are
births$sex[births$sex==9] <- NA
births$sex_f <- factor(births$sex, levels=c(1,2), labels=c("Male", "Female"))
table(births$sex_f, births$sex, useNA="always")

# (HW1.Q5 continued) 
### G. Maternal Race/Ethnicity (covariate) 
#### i
table(births$mrace, births$methnic, useNA = "always") # check what initial values are

## ii
mergedf <- data.frame(
  mrace = c(sort(rep(seq(1,4),3))),
  methnic = as.character(rep(c("Y", "N", "U"), 4)),
  raceeth_f =factor(c("White Hispanic", "White non-Hispanic", "Other",
                      rep("African American", 3), 
                      rep("American Indian or Alaska Native", 3),
                      rep("Other", 3)
  )
  ), 
  stringsAsFactors = F)

births <- merge(x=births, y=mergedf, by=c("mrace", "methnic"))

#### iii
table(births$mrace, births$methnic, births$raceeth_f, useNA = "always") # looks good
# ......................................
```
</div>

### Question 6, Epi Packages
1. Optional Challenges: Useful early Packages 
	1. Use the tableone:: package to print out a Table 1 of some of your variables of interest 
	2. Use the mice:: package to print out misingness patterns 
	3. Use ggplot2:: package with ggpairs() to print a plot matrix of a sample() (for time/size reasons) of your data 
**Note, the code here provided without the output**

<div class="fold o"> 
```{r, echo=T, warning=F, message=F}

# ......................................
# Optional data exploration (HW1.Q6) ####
# ......................................

# (HW1.Q6) 
## A
#CreateTableOne(vars = c("preterm_f"), strata = c("mage", "pnc5_f", "smoker_f", "sex_f"), data = births) 

## B
# mice::md.pattern(births) # the output here is a lot, so I have opted so comment it out for space concerns 


## C
# GGally::ggpairs(data = births[1:1000, c("pnc5_f", "preterm_f")], title="Exposure versue Outcome for First 1,00 Obserations")

```
</div>


# Homework 2
## Overview of Homework 2
The purpose of this homework is to familiarize you with the `apply` family, which are powerful tools that build on vectorization (which converts to speed in R).

### Question 1, Create Dates
1.  Create useful calculated variables 
	2. Week number: Create the weeknum variable in the births dataset using the week() function in lubridate and the date of birth (dob) variable in already in. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}
# ......................................
# Eligibility criteria & core recoding  (HW2 part 1)
# ......................................
# Create many inclusion variables, all of which have to be =1 to be included.
births$weeknum = week(births$dob_d) #thanks, lubridate! (HW2.1.Q1)
```
</div>

### Question 2, Exclusion Criteria
1. We will now exclude births from the study to simplify and hone our research question. Specifically, we’ll look at births that have data on our variables of interest, had all their weeks of gestation at risk of preterm birth within our study year, are single births, and have no congenital anomalies. In each case we’ll create a variable starting with “incl_” in the dataset so we can keep track of various criteria for study inclusion, with the `variable = 1` meaning it passes that inclusion test, and _0_ meaning it does not pass. We’ll use `apply()` functions where helpful to help reduce our code. The as.numeric() function may be helpful to cast Booleans to _1s_ and _0s_, though `T` and `F` are interpreted intelligently as _1_ and _0_ as well – these instructions are based on _1s_ and _0s_, but you may use `T` and `F` if that makes more sense to you. 
	1. **Has Gestation**: Create incl_hasgest in the births dataset to be a 1 if the birth has wksgest data, 0 if missing. 
	2. **Enough gest**: Create incl_enoughgest in the births dataset to be a 1 if the birth has >= 20 weeks of gestation, 0 if otherwise. 
	3. **Late enough**: Create incl_lateenough to be 1 when wksgest-weeknum <= 19, 0 otherwise.  
	4. **Early enough**: Create incl_earlyenough to be 1 when weeknum - wksgest <= 7, 0 otherwise. 
	5. **Singletons**: Create incl_singleton to be 1 when plur is 1, 0 otherwise. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}

# a. Has gestation data (weeks), and at least 20 weeks gestation pre-birth (weeks >= 20)
births$incl_hasgest = as.numeric(!is.na(births$wksgest)) #(HW2.1.Q2a)
births$incl_enoughgest = as.numeric(births$wksgest >= 20) #(HW2.1.Q2b)
# b. Less than 20 weeks gestation before Jan 1 of year (LMP > Aug 20), or weeks-weeknum>=19, w/ weeknum=1 for Jan 1-7
births$incl_lateenough = as.numeric(births$wksgest - births$weeknum <= 19) #(HW2.1.Q2c)
# c. Start date of gestation was 45 (max gest in'11) w prior to Jan 1 of next year, so all births are observed in year
births$incl_earlyenough = as.numeric(births$weeknum - births$wksgest <=7) #(HW2.1.Q2d)
# d. singletons only
births$incl_singleton = as.numeric(births$plur == 1) #(HW2.Q2e)


```
</div>

### Question 3, Create congenital anomaly variable using `apply()` 
1. Create congenital anomaly variable using apply() 
There is no single “has any congenital anomaly” variable, so we’ll need to create one.  Some hints: Use the MARGIN parameter of apply() to decide between rows and columns (we’ll want rows). The dataframe to pass to apply() will need to be subsetted to just the congen_anom variables. It may be easiest to send that dataframe into apply() as all Booleans (e.g. df[subsetting-goes-here] ==”N”).
	1. Create name vector: Create a variable congen_anom (outside births) to be equal to a vector of the names of congenital anomaly variables. You would normally refer to the meta data, but to save you typing, here are those variables in an array: 
`c("anen","mnsb","cchd", "cdh", "omph","gast", "limb", "cl","cp","dowt","cdit", "hypo")`
	2. Check all anomalies at once: Use `apply()` with the `all()` function on the congenital anomaly columns of births to return a _1_ if all congenital anomaly variables are “N”, _0_ otherwise and assign it to variable incl_noanomalies. 


<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}

# e. no congential anomalies - Let's use apply for efficiency
congen_anom = c("anen","mnsb","cchd", "cdh", "omph","gast", "limb", "cl","cp","dowt","cdit", "hypo") #(HW2.1.Q3a)
  # below is just a useful aside to check that there is No "U" (i.e. none missing) before running the code to make the new variable
  births$incl_hasanomdata = as.numeric(apply(births[,congen_anom]!="U", FUN=all, 1)) #All not missing = not any missing
births$incl_noanomalies = as.numeric(apply(births[,congen_anom]=="N", FUN=all, 1)) #All not present #(HW2.1.Q3b)


```
</div>


### Question 4, Finish the inclusion criteria 
1. Finish the inclusion criteria 
	1. Save your dataset, before we subset it, as old_births. If you need to in the future, you can `birth=old_births` to reset your work, since this dataset is relatively small (sometimes I’ll save these sorts of save points in a comment... ).  
	2. Explore the `grepl` function. To take advantage of our `incl_` naming convention, we’ll use a text search function, `grepl`. As an example, try (and note the misspelling of banana) : `grepl("a", c("banana", "peach", "ornge"))` 
	3. (Optional Challenge): In one line of R, report the number that failed each inclusion test using `apply()` and sum over the column margins instead of rows. The `grepl` function may be useful to subset births to the inclusion criteria of interest. 
	4. Create overall inclusion variable: Create a variable in our dataset include_allpass that represents a _1_ if all inclusion criteria are passed. Using the `grepl()` function to find just the variables with incl_ in their name, subset births to be just those that have a _1_ in every incl_ variable. This is similar to what’s done in _3c_, above, but looks at rows instead of columns.  
	5. Subset to create a new births dataset on the outcome of that apply function, just including births that pass the inclusion criteria.  
	6. Summarize exclusion: Report the number of births before and after the inclusion criteria using `nrow()` or `dim()`. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}


old_births <- births #(HW2.1.Q4a)

# Below is the example grepl (HW2.1.Q4b)
grepl("a", c("banana", "peach", "ornge")) 

eligibility_drops = nrow(births) - apply(births[,grepl("incl_", names(births))], FUN=sum, MARGIN = 2, na.rm=T) #(HW2.1.Q4c optional)
eligibility_drops #(HW2.1.Q4c optional)

births$include_allpass = apply(births[, grepl("incl_", names(births))], FUN=all, MARGIN = 1) #(HW2.1.Q4d indicator for the inclusion criteria yes/no)

births = births[births$include_allpass, ] #(HW2.1.Q4e now apply the inclusion criteria to subset your births data set)
  # to see what warnings are being thrown you can type warnings() -- below:  
  warnings() # Just letting me know I'm casting those 1s as TRUEs. That's ok.

dim(old_births) #(HW2.1.Q4f)
dim(births) #(HW2.1.Q4f)


```
</div>


### Question 5, Optional Challenge
1. Optional Challenge: Create an “any exclusion” variable in oldbirths (before we subset it). Use tableone::CreateTableOne grouped by that variable to describe the difference in the exclusion and inclusion cohorts. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}

#(HW2.1.Q5 Optional Challenge)
# Results of exclusion
cat("Leaving eligibility checks with n =", formatC(nrow(births), big.mark = ","), 
    "births of original", formatC(nrow(old_births), big.mark = ",")) #(HW2.1.Q4d)
# names(births)

vars_of_interest = c("pnc5_f", "preterm_f", "smoker_f", "wksgest", "sex", "mage", "meduc", "raceeth_f", "weeknum", "include_allpass")
tableone::kableone(tableone::CreateTableOne(data=births[, vars_of_interest])) #(HW2.1.Q5)
  # let's look at who was included and excluded in our database 
  # This is the same as question 4 but now I am running it on the      birth dataset that has not been subsetted (i.e. we could have      already saved this variable earlier on or we can easily            recreate it)
old_births$include_allpass <- apply(old_births[, grepl("incl_", names(old_births))], FUN=all, MARGIN = 1)

tableone::kableone(tableone::CreateTableOne(data=old_births[, vars_of_interest], strata="include_allpass"))

# ......................................
# NOTES: Finishes with 62,370 of 122,513 
# ......................................

```
</div>

```{r, echo=F}
# here for internal consistency is the dataset after HW2

write_csv(x = births, path = "data/births_afterHW2.csv")
```

# Homework 3
## Overview of Homework 3
In this section of the homework we will start with the `tidyverse`, and focus on the `dplyr` and `ggplot2` packages. As discussed in class, there are powerful packages that make cleaning, analyzing, and graphing data "easy" (or at least tidy!).  

## Homework 3, Part 1
### Question 1, Finish the inclusion criteria 
#### Question 1A-C
1. Mimic Graphs: Mimic these graphs as best you can using ggplot2 and paste them in below each graph. If they aren’t exact, that’s fine! Until we know how to use dplyr thoroughly to create summary data, you’ll likely need to use the ..prop and ..count hidden variables (as covered in ggplot2 class) to create these graphs. These are tough concepts; take your time and don’t be afraid to help each other!   
	1. Figure 1A (distribution of gestational age)
	2. Figure 1B (weeknum distribution)
	3. Figure 1C (week vs. weeknum)

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}
#(HW3.1.Q1A) Graph weeks
npop = formatC(sum(!is.na(births$wksgest)), big.mark=',') #(HW3.1.Q1a)
fig1a <- ggplot(data=births, aes(x=wksgest, y=..prop..))+geom_bar() + #Does what you need, as does geom_histogram()
  labs(title="Figure 1: Proportional distribution of gestational age at birth", 
       subtitle=paste0("From ", npop, " births in NC in 2012 from the NC SCHS, \n posted at Odum Institute"), 
       x="Weeks of gestation", y="Proportion of population") + 
  theme_bw()


  #(HW3.1.Q1a): Working with weeknum. - should double check this. Just used %V above.
#  hist(births$weeknum, breaks = min(births$weeknum):max(births$weeknum)) # Looks weird



#(HW3.1.Q1B) : Graph weeknum 
fig1b <- ggplot(births, aes(x=weeknum, y=..prop..)) + geom_bar() +
  labs(title="Throwaway: Investigating Weeknum", 
       subtitle="Note to self : Weeknum needs some work, \n doesn't quite match SAS", 
       x="Week number of birth", y="Proportion of population") +
  theme_bw()


#(HW3.1.Q1C) weeks vs. weeknum 
fig1c <- ggplot(births, aes(x=wksgest, y=weeknum)) + 
  geom_jitter(width=1, height=1, pch=".", alpha=0.3)+
  labs(title="Throwaway: week vs. weeknum", 
       subtitle="Note to self: Does this match what we expect given the inclusion criteria?",
       x="weeks of gestation", y="week number of birth in year")+
  theme_bw()

plot(gridExtra::arrangeGrob(fig1a, fig1b, fig1c, layout_matrix = rbind(c(1,2), c(3,3))))


```
</div>

#### Question 1D
	4.	Change a graph from questions a, b or c using ggplot’s “+” syntax to add a layer. You can do anything you like, but as a suggestion, try taking a saved plot c and adding geom_bin2d(binwidth=1, alpha=0.8).  
 
<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}

#(HW3.1.Q1D)
# Note here that you can ggplot objects that are "appendable" 
# which is to say you can add on new features by adding on LAYERS 
plotObj <- ggplot(births, aes(x=wksgest, y=weeknum)) + 
  geom_jitter(width=1, height=1, pch=".", alpha=0.3)+
  labs(title="Throwaway: week vs. weeknum", 
       subtitle="Note to self: Does this match what we expect given the inclusion criteria?", 
       x="weeks of gestation", y="week number of birth in year")+
  theme_bw()

plot(plotObj)

## append new feature
plotObj + geom_bin2d(binwidth=1, alpha=0.8) + labs(caption = "Look we appended a layer here!")

```
</div>

#### Question 1E
	5. Create your own! Create and submit any ggplot2 graphic you like built from the births dataset and using our variables of interest. Use at least two geometry layers, a title, a subtitle, and a caption that describes your interpretation of the punchline of your graph. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}
#install.packages("ggridges")
library("ggridges")
ggplot() + 
  geom_density_ridges_gradient(data=births, aes(x=mage, y=factor(cut(wksgest, 10)), fill=..x..)) + 
  scale_fill_gradientn(colors=c("#fc8d59", "#ffffbf", "#91cf60")) + 
  facet_grid(meduc~raceeth_f) +
  ggtitle("Distribution of Weeks Gestation by Birth Outcome") + 
  labs(subtitle="This is the continuous variable we dichotomized") + 
  ylab("Weeks of Gestations factorized") + xlab("mage") + 
  theme_bw()

```
</div>

## Homework 3, Part 2
This section of the homework will focus a bit more on "piping" with `magrittr` and using `dplyr`. 

### Question 2, Summary Table for mage
Create a summary table for maternal age: Using dplyr, create a summary table for mage from the births dataset whose head looks like below:   
**Investigate why maternal age of 54 gives a NaN for the newly created `pct_earlyPNC` variable (hint -- what would the mean of all missing be?).**

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis'}
# ......................................
# Functional Form of maternal age w/ dplyr and ggplot2 #(HW3 part 2)
# ......................................

mage_df = births %>% group_by(mage) %>% #(HW3.2.2) setup 
  summarize(n=n(), 
            pct_earlyPNC = mean(pnc5, na.rm=T),
            pct_preterm = mean(preterm, na.rm=T)) %>% 
  mutate_if(is.numeric, round, 2)

DT::datatable(mage_df) #(HW3.2.2) answer 


```
</div>

### Question 3, Explore functional form
1.	Create a ggplot similar to the below plot that demonstrates the functional form of maternal age to the risk of preterm birth. Note that the “weight” aesthetic will be important so that the larger center bins appropriately pull most of the quick loess model.    
2.	**Optional Challenge**: Consider the “on the fly” linear square term model as a functional form – if you want to attempt it, check the help page for geom_smooth, looking at the method and formula parameters. Also check out [UCLA's IDRE](https://stats.idre.ucla.edu/r/faq/how-can-i-explore-different-smooths-in-ggplot2/) help pages. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}

#(HW3.2.3A)  
fig2a <- ggplot(mage_df, aes(mage, pct_preterm))+ 
  geom_point(aes(size=n))+
  geom_smooth(aes(weight=n), color="blue", method="loess")+
  labs(title="% Preterm vs. Maternal Age", 
       x="maternal age", y="% preterm", 
       subtitle="Investigating function form of maternal age", 
       caption="Note for future glms: Seems quadratic. Blue is loess, red is square linear.")

#(HW3.2.3B)  Optional Challenge  
fig2b <- ggplot(mage_df, aes(mage, pct_preterm)) + 
  geom_point(aes(size=n)) +
  geom_smooth(aes(weight=n), color="blue") +
  geom_smooth(aes(weight=n), method="lm", formula=y ~ poly(x, 2), color="red", lty=2) + # this is the square error term
  labs(title="% Preterm vs. Maternal Age", 
       x="maternal age", y="% preterm", 
       subtitle="Investigating function form of maternal age", 
       caption="Note for future glms: Seems quadratic. Blue is loess, red is square linear.")



plot(gridExtra::arrangeGrob(fig2a, fig2b))


```
</div>

## Homework 3, Part 3


### Question 4, Create a County Summary Table
Using similar dplyr techniques, we’ll create a county table. In this case we’ll also read in a helper table and do some work with it. 

1. Read in birth format helper 2012.csv. Using base R we’ve learned previously, perform these tasks to convert it to a table called county_data:	1. Figure 1A (distribution of gestational age). 
	1. i.	Filter to just include rows where variable is cores. 
	2. ii.	Rename the columns to variable, cores, county_name and FIPS.   
	3. iii.	Drop the “variable” column. 
	4. iv.	Covert cores to a number if it is a character (check with str()!). 
	
<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}
format_helper = read.csv("data/birth-format-helper-2012.csv", stringsAsFactors = F)
#(HW3.3.4A.i) 
county_data = format_helper[format_helper$variable == "cores",] #base R way
#(HW3.3.4A.ii) 
names(county_data) = c("variable", "cores", "county_name", "FIPS")
#(HW3.3.4A.iii) 
county_data$var = NULL #drop in base R. There are other ways...
#(HW3.3.4A.iv) 
county_data$cores = as.numeric(county_data$cores)
# str(county_data$cores)

```
</div>

2. Using dplyr and pipes, complete the same tasks to create county_data from format_helper in “one line” (even if you indent it). You’ll need the filter(), rename(), select() and mutate() functions.  

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}
#(HW3.3.4B) same results as above but now using "tidy" methods and more human readable 
county_data = format_helper %>% 
  filter(variable == "cores") %>%
  rename(cores=code, county_name=recode, FIPS=helper) %>% 
  select(-variable) %>%
  mutate(cores = as.numeric(cores))

```
</div>

1. Download and read in county_tiers.csv into a county_tiers data.frame from the NC Department of Commerce (https://www.nccommerce.com/research-publications/incentive-reports/county-tier-designations). For convenience, the csv is available on the course website.   
	2. What type of variable is econ_tier ?  
	3. Convert econ-tier from integer to a factor using ordered() or factor() with the right parameters.  
	
<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}
#(HW3.3.4C)
# Load tier data 
# https://www.nccommerce.com/research-publications/incentive-reports/county-tier-designations 
county_tiers = read.csv("data/county_tiers.csv", stringsAsFactors = F) 

#(HW3.3.4C.i)
# str(county_tiers$econ_tier)
#(HW3.3.4C.ii)
county_tiers$econ_tier = ordered(county_tiers$econ_tier)

```
</div>

4. In one dplyr statement, create county_df data.frame that has its head() like below. You’ll need group_by(), summarize() (with n()!), and two left_join().    

<div class="fold o"> 
```{r, echo=T, warning=F, message=F}
#(HW3.3.4D)
county_df = births %>% group_by(cores) %>%
  summarize(n=n(), 
            pct_earlyPNC = mean(pnc5, na.rm=T),
            pct_preterm = mean(preterm, na.rm=T)) %>%
  left_join(county_data, by = "cores") %>% 
  left_join(county_tiers, by = "county_name")
# head(county_df) #(HW3.2.3D) output

```
</div>


5. Write the data.frame you’ve created to a local file called “county_birth_summary.csv” We may use it later (e.g. to build a map)       

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='hide', fig.width=11, fig.height=8}

#(HW3.3.4E) write this out to your local directory
write.csv(x=county_df, "data/county_birth_summary.csv", row.names = F, quote = F)

```
</div>


### Question 5, ggplot economic tier
Create a ggplot (and paste in here) that describes the relationship between the percent of our exposure, outcome, and economic tier of the county. There are many ways to do this!    

1. Challenge: you might consider using plotly package to “hand” explore this interesting summary dataset.   

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}

#(HW3.3.5)
# Create a plot with ggplot
plotObj <- ggplot(county_df, aes(x=pct_earlyPNC, y=pct_preterm, color=econ_tier))+
  geom_point(aes(size=n))+geom_text(aes(label=county_name), nudge_y=.01, alpha=0.5)+
  geom_smooth(se=F)
plot(plotObj)
#(HW3.3.5a)
# plotly::ggplotly(plotObj)

```
</div>


### Question 6, dplyr gather() and ordered factors.
*Note, this question is just a few lines of R, but definitely a challenge. This is not the best way to map these aesthetics to answer this question; the point of this question is to challenge you to use ordered factors with dplyr:: gather (for later input as facets in ggplot).*

1.	Create an ordered factor county_name_ord that’s ordered by the pct_earlyPNC variable (this factor will specify the plot order below).  
2.	Use dplyr gather() to create a data.frame that turns our variables n, pct_earlyPNC and pct_preterm into variables where the name is in one column and the value in another. See the head() below to understand the goal of gather for this question.  
3.	Use this newly created variable to facet your ggplot and produce something similar to below. 

<div class="fold o"> 
```{r, echo=T, warning=F, message=F, results='asis', fig.width=11, fig.height=8}

#(HW3.3.6A)
county_name_ord = factor(county_df$county_name, county_df$county_name[order(county_df$pct_earlyPNC)], ordered=T)

#(HW3.3.6B)
county_df <- county_df %>% 
  mutate(county_name_ord = county_name_ord) %>%
  gather(key=variable, value=value, n, pct_earlyPNC, pct_preterm) %>% 
  head()
#(HW3.3.6C)
county_df %>% 
ggplot(aes(county_name_ord, value, fill=econ_tier)) + 
  geom_col() + 
  coord_flip() + 
  facet_wrap(~variable, scales = "free_x")

```
</div>


# Homework 4
## Homework 4, Part 1

